{"version":3,"file":"shadow.global.js","sources":["../src/shadow.tsx"],"sourcesContent":["import { defineComponent, h, ref, Teleport, onBeforeMount, onMounted, computed, reactive, PropType, watch } from 'vue'\r\nimport type { App, VNode } from 'vue'\r\n\r\ntype GShadowRoot = typeof global.ShadowRoot.prototype\r\n\r\nexport interface ShadowOption {\r\n    mode?: 'open' | 'closed'\r\n    delegatesFocus?: boolean\r\n}\r\n\r\nexport function makeShadow(el: Element, option?: ShadowOption) {\r\n    return makeShadowRaw(el, el.childNodes, option)\r\n}\r\nexport function makeShadowRaw(rootEl: Element, childNodes?: Iterable<Node>, option?: ShadowOption): ShadowRoot | undefined\r\nexport function makeShadowRaw(rootEl: Element, childNodes?: Iterable<Node>, { mode = 'open', delegatesFocus = false }: ShadowOption = { mode: 'open' }) {\r\n    try {\r\n        const oldroot = rootEl.shadowRoot\r\n        if (oldroot != null) {\r\n            console.error('[shadow] Attach shadow multiple times', rootEl, childNodes, oldroot)\r\n            return\r\n        } else {\r\n            const shadow_root = rootEl.attachShadow({ mode, delegatesFocus })\r\n            if (childNodes) putDomIntoShadow(shadow_root, childNodes)\r\n            return shadow_root\r\n        }\r\n    } catch (e) {\r\n        console.error('[shadow] make shadow-root failed', rootEl, childNodes)\r\n        console.error(e)\r\n    }\r\n}\r\n\r\n// function removeShadow(rootEl: Element): Element {\r\n//     const newroot = rootEl.cloneNode() as Element\r\n//     while (rootEl.hasChildNodes()) {\r\n//         newroot.appendChild(rootEl.firstChild!)\r\n//     }\r\n//     rootEl.parentElement!.replaceChild(newroot, rootEl)\r\n//     console.log('removeShadow', newroot)\r\n//     return newroot\r\n// }\r\n\r\nfunction putDomIntoShadow(shadow_root: GShadowRoot, childNodes: Iterable<Node>) {\r\n    const fragment = document.createDocumentFragment()\r\n    for (const node of childNodes) {\r\n        fragment.appendChild(node)\r\n    }\r\n    shadow_root.appendChild(fragment)\r\n}\r\n\r\nconst virtual_root = document.createDocumentFragment()\r\n\r\nexport const ShadowStyle = defineComponent({\r\n    props: {\r\n        media: String,\r\n        nonce: String,\r\n    },\r\n    setup(props, { slots }) {\r\n        return (): VNode => (\r\n            <style media={props.media} nonce={props.nonce}>\r\n                {slots.default?.()}\r\n            </style>\r\n        )\r\n    },\r\n})\r\n\r\nexport interface ShadowRootExpose {\r\n    shadow_root?: GShadowRoot\r\n}\r\n\r\nexport const ShadowRoot = withType<{\r\n    install: typeof install\r\n    Style: typeof ShadowStyle\r\n}>()(\r\n    defineComponent({\r\n        props: {\r\n            mode: {\r\n                type: String as PropType<'open' | 'closed'>,\r\n                default: 'open',\r\n            },\r\n            delegatesFocus: {\r\n                type: Boolean,\r\n                default: false,\r\n            },\r\n            abstract: {\r\n                type: Boolean,\r\n                default: false,\r\n            },\r\n            tag: {\r\n                type: String,\r\n                default: 'div',\r\n            },\r\n            adoptedStyleSheets: {\r\n                type: Array as PropType<CSSStyleSheet[]>,\r\n            },\r\n        },\r\n        emits: ['error'],\r\n        setup(props, { slots, expose, emit }) {\r\n            const abstract = ref(false)\r\n\r\n            const el = ref<HTMLElement>()\r\n            const teleport_el = ref<HTMLElement>()\r\n            const shadow_root = ref<GShadowRoot>()\r\n\r\n            const teleport_target = computed(() => shadow_root.value ?? virtual_root)\r\n\r\n            const ex: ShadowRootExpose = reactive({\r\n                shadow_root,\r\n            })\r\n            expose(ex)\r\n\r\n            onBeforeMount(() => {\r\n                abstract.value = props.abstract\r\n            })\r\n\r\n            onMounted(() => {\r\n                try {\r\n                    if (abstract.value) {\r\n                        if (teleport_el.value!.parentElement!.shadowRoot) {\r\n                            shadow_root.value = teleport_el.value!.parentElement!.shadowRoot\r\n                        } else {\r\n                            shadow_root.value = makeShadowRaw(teleport_el.value!.parentElement!, void 0, {\r\n                                mode: props.mode,\r\n                                delegatesFocus: props.delegatesFocus,\r\n                            })\r\n                        }\r\n                    } else {\r\n                        shadow_root.value = makeShadowRaw(el.value!, void 0, { mode: props.mode, delegatesFocus: props.delegatesFocus })\r\n                    }\r\n                    shadow_root.value?.styleSheets\r\n                } catch (e) {\r\n                    console.error(e)\r\n                    emit('error', e)\r\n                }\r\n            })\r\n\r\n            watch([shadow_root, () => props.adoptedStyleSheets], ([shadow_root, adoptedStyleSheets]) => {\r\n                if (!shadow_root || !adoptedStyleSheets) return\r\n                try {\r\n                    ;(shadow_root as any).adoptedStyleSheets = adoptedStyleSheets\r\n                } catch (e) {\r\n                    console.error(e)\r\n                    emit('error', e)\r\n                }\r\n            })\r\n\r\n            return (): VNode => {\r\n                const child_part = (\r\n                    <Teleport ref={teleport_el} to={teleport_target.value}>\r\n                        {[slots.default?.()]}\r\n                    </Teleport>\r\n                )\r\n                if (abstract.value) return child_part\r\n                return <props.tag ref={el}>{child_part}</props.tag>\r\n            }\r\n        },\r\n        install,\r\n        Style: ShadowStyle,\r\n    })\r\n)\r\n\r\nfunction withType<W>(): <T>(obj: T) => T & W {\r\n    return obj => obj as any\r\n}\r\n\r\nexport function install(app: App) {\r\n    app.component('shadow-root', ShadowRoot)\r\n\r\n    app.directive('shadow', {\r\n        beforeMount(el: HTMLElement) {\r\n            console.warn('[VueShadowDom] Deprecated v-shadow directive, use <shadow-root> component')\r\n            makeShadow(el)\r\n        },\r\n    })\r\n}\r\n\r\nexport { ShadowRoot as shadow_root, ShadowStyle as shadow_style }\r\nexport default { ShadowRoot, ShadowStyle, shadow_root: ShadowRoot, shadow_style: ShadowStyle, install }\r\n"],"names":["defineComponent","h","ref","computed","reactive","onBeforeMount","onMounted","watch","Teleport"],"mappings":";;;;;;aAUgB,UAAU,CAAC,EAAW,EAAE,MAAqB;QACzD,OAAO,aAAa,CAAC,EAAE,EAAE,EAAE,CAAC,UAAU,EAAE,MAAM,CAAC,CAAA;IACnD,CAAC;aAEe,aAAa,CAAC,MAAe,EAAE,UAA2B,EAAE,EAAE,IAAI,GAAG,MAAM,EAAE,cAAc,GAAG,KAAK,KAAmB,EAAE,IAAI,EAAE,MAAM,EAAE;QAClJ,IAAI;YACA,MAAM,OAAO,GAAG,MAAM,CAAC,UAAU,CAAA;YACjC,IAAI,OAAO,IAAI,IAAI,EAAE;gBACjB,OAAO,CAAC,KAAK,CAAC,uCAAuC,EAAE,MAAM,EAAE,UAAU,EAAE,OAAO,CAAC,CAAA;gBACnF,OAAM;aACT;iBAAM;gBACH,MAAM,WAAW,GAAG,MAAM,CAAC,YAAY,CAAC,EAAE,IAAI,EAAE,cAAc,EAAE,CAAC,CAAA;gBACjE,IAAI,UAAU;oBAAE,gBAAgB,CAAC,WAAW,EAAE,UAAU,CAAC,CAAA;gBACzD,OAAO,WAAW,CAAA;aACrB;SACJ;QAAC,OAAO,CAAC,EAAE;YACR,OAAO,CAAC,KAAK,CAAC,kCAAkC,EAAE,MAAM,EAAE,UAAU,CAAC,CAAA;YACrE,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAA;SACnB;IACL,CAAC;IAED;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IAEA,SAAS,gBAAgB,CAAC,WAAwB,EAAE,UAA0B;QAC1E,MAAM,QAAQ,GAAG,QAAQ,CAAC,sBAAsB,EAAE,CAAA;QAClD,KAAK,MAAM,IAAI,IAAI,UAAU,EAAE;YAC3B,QAAQ,CAAC,WAAW,CAAC,IAAI,CAAC,CAAA;SAC7B;QACD,WAAW,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAA;IACrC,CAAC;IAED,MAAM,YAAY,GAAG,QAAQ,CAAC,sBAAsB,EAAE,CAAA;UAEzC,WAAW,GAAGA,mBAAe,CAAC;QACvC,KAAK,EAAE;YACH,KAAK,EAAE,MAAM;YACb,KAAK,EAAE,MAAM;SAChB;QACD,KAAK,CAAC,KAAK,EAAE,EAAE,KAAK,EAAE;YAClB,OAAO,OACHC,iBAAO,KAAK,EAAE,KAAK,CAAC,KAAK,EAAE,KAAK,EAAE,KAAK,CAAC,KAAK,IACxC,KAAK,CAAC,OAAO,IAAI,CACd,CACX,CAAA;SACJ;KACJ,EAAC;UAMW,UAAU,GAAG,QAAQ,EAG9B,CACAD,mBAAe,CAAC;QACZ,KAAK,EAAE;YACH,IAAI,EAAE;gBACF,IAAI,EAAE,MAAqC;gBAC3C,OAAO,EAAE,MAAM;aAClB;YACD,cAAc,EAAE;gBACZ,IAAI,EAAE,OAAO;gBACb,OAAO,EAAE,KAAK;aACjB;YACD,QAAQ,EAAE;gBACN,IAAI,EAAE,OAAO;gBACb,OAAO,EAAE,KAAK;aACjB;YACD,GAAG,EAAE;gBACD,IAAI,EAAE,MAAM;gBACZ,OAAO,EAAE,KAAK;aACjB;YACD,kBAAkB,EAAE;gBAChB,IAAI,EAAE,KAAkC;aAC3C;SACJ;QACD,KAAK,EAAE,CAAC,OAAO,CAAC;QAChB,KAAK,CAAC,KAAK,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,IAAI,EAAE;YAChC,MAAM,QAAQ,GAAGE,OAAG,CAAC,KAAK,CAAC,CAAA;YAE3B,MAAM,EAAE,GAAGA,OAAG,EAAe,CAAA;YAC7B,MAAM,WAAW,GAAGA,OAAG,EAAe,CAAA;YACtC,MAAM,WAAW,GAAGA,OAAG,EAAe,CAAA;YAEtC,MAAM,eAAe,GAAGC,YAAQ,CAAC,MAAM,WAAW,CAAC,KAAK,IAAI,YAAY,CAAC,CAAA;YAEzE,MAAM,EAAE,GAAqBC,YAAQ,CAAC;gBAClC,WAAW;aACd,CAAC,CAAA;YACF,MAAM,CAAC,EAAE,CAAC,CAAA;YAEVC,iBAAa,CAAC;gBACV,QAAQ,CAAC,KAAK,GAAG,KAAK,CAAC,QAAQ,CAAA;aAClC,CAAC,CAAA;YAEFC,aAAS,CAAC;gBACN,IAAI;oBACA,IAAI,QAAQ,CAAC,KAAK,EAAE;wBAChB,IAAI,WAAW,CAAC,KAAM,CAAC,aAAc,CAAC,UAAU,EAAE;4BAC9C,WAAW,CAAC,KAAK,GAAG,WAAW,CAAC,KAAM,CAAC,aAAc,CAAC,UAAU,CAAA;yBACnE;6BAAM;4BACH,WAAW,CAAC,KAAK,GAAG,aAAa,CAAC,WAAW,CAAC,KAAM,CAAC,aAAc,EAAE,KAAK,CAAC,EAAE;gCACzE,IAAI,EAAE,KAAK,CAAC,IAAI;gCAChB,cAAc,EAAE,KAAK,CAAC,cAAc;6BACvC,CAAC,CAAA;yBACL;qBACJ;yBAAM;wBACH,WAAW,CAAC,KAAK,GAAG,aAAa,CAAC,EAAE,CAAC,KAAM,EAAE,KAAK,CAAC,EAAE,EAAE,IAAI,EAAE,KAAK,CAAC,IAAI,EAAE,cAAc,EAAE,KAAK,CAAC,cAAc,EAAE,CAAC,CAAA;qBACnH;oBACD,WAAW,CAAC,KAAK,EAAE,WAAW,CAAA;iBACjC;gBAAC,OAAO,CAAC,EAAE;oBACR,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAA;oBAChB,IAAI,CAAC,OAAO,EAAE,CAAC,CAAC,CAAA;iBACnB;aACJ,CAAC,CAAA;YAEFC,SAAK,CAAC,CAAC,WAAW,EAAE,MAAM,KAAK,CAAC,kBAAkB,CAAC,EAAE,CAAC,CAAC,WAAW,EAAE,kBAAkB,CAAC;gBACnF,IAAI,CAAC,WAAW,IAAI,CAAC,kBAAkB;oBAAE,OAAM;gBAC/C,IAAI;oBACA,CAAC;oBAAC,WAAmB,CAAC,kBAAkB,GAAG,kBAAkB,CAAA;iBAChE;gBAAC,OAAO,CAAC,EAAE;oBACR,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAA;oBAChB,IAAI,CAAC,OAAO,EAAE,CAAC,CAAC,CAAA;iBACnB;aACJ,CAAC,CAAA;YAEF,OAAO;gBACH,MAAM,UAAU,IACZN,MAACO,YAAQ,IAAC,GAAG,EAAE,WAAW,EAAE,EAAE,EAAE,eAAe,CAAC,KAAK,IAChD,CAAC,KAAK,CAAC,OAAO,IAAI,CAAC,CACb,CACd,CAAA;gBACD,IAAI,QAAQ,CAAC,KAAK;oBAAE,OAAO,UAAU,CAAA;gBACrC,OAAOP,MAAC,KAAK,CAAC,GAAG,IAAC,GAAG,EAAE,EAAE,IAAG,UAAU,CAAa,CAAA;aACtD,CAAA;SACJ;QACD,OAAO;QACP,KAAK,EAAE,WAAW;KACrB,CAAC,EACL;IAED,SAAS,QAAQ;QACb,OAAO,GAAG,IAAI,GAAU,CAAA;IAC5B,CAAC;aAEe,OAAO,CAAC,GAAQ;QAC5B,GAAG,CAAC,SAAS,CAAC,aAAa,EAAE,UAAU,CAAC,CAAA;QAExC,GAAG,CAAC,SAAS,CAAC,QAAQ,EAAE;YACpB,WAAW,CAAC,EAAe;gBACvB,OAAO,CAAC,IAAI,CAAC,2EAA2E,CAAC,CAAA;gBACzF,UAAU,CAAC,EAAE,CAAC,CAAA;aACjB;SACJ,CAAC,CAAA;IACN,CAAC;AAGD,iBAAe,EAAE,UAAU,EAAE,WAAW,EAAE,WAAW,EAAE,UAAU,EAAE,YAAY,EAAE,WAAW,EAAE,OAAO,EAAE;;;;;;;;;;;;;;;;;"}